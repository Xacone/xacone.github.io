<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Best EDR Of The Market v1.1.0</title>
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css" />
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/9000.0.1/prism.min.js">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/9000.0.1/themes/prism-coy.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/default.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>

        <script src="js/imagezoom.js"> </script>
        <link rel="stylesheet" href="css/imagezoom.css">
    </head>

    <style>
        body {
            color: black;
            zoom: 90%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }
        th {
            background-color: #f2f2f2;
        }

        pre {
            font-size:  12px;
        }


    </style> 
    <body style="font-size: 17px; zoom: 90%;">
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-light" id="mainNav">
            <div class="container px-4 px-lg-5">
                <a class="navbar-brand" href="index.html">Yazid's notes</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    Menu
                    <i class="fas fa-bars"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ms-auto py-4 py-lg-0">
                        <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="index.html">Home</a></li>
                        <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="about.html">About</a></li>                    
                    </ul>
                </div>
            </div>
        </nav>
        <!-- Page Header-->
        <header class="masthead" style="background-image: url('assets/img/beotm_banner_1_1_0.png')">
            <div class="container position-relative px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-md-10 col-lg-8 col-xl-7">
                        <div class="post-heading">
                            <h1>Best EDR Of The Market v1.1.0 üê≤‚Äã‚Äã</h1>
                            <h2 class="subheading">I see no opponents right up there.</h2>
                            <span class="meta">
                                Posted by
                                <a href="#!">Yazid</a>
                                on April 14, 2024
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- Post Content-->
        <article class="mb-4" style=" text-align: justify; ">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-md-10 col-lg-8 col-xl-7">

                        <br>
                        <div style="display: flex; justify-content: center; align-items: center;">
                            <img width="100%" src="assets/img/beotm_banner2.png">
                        </div>    

                      

                          <!--<blockquote style="text-align: center;"><i>You gotta worry bout' them malicious processes...</i></blockquote>-->

                          <br><br>
                          The first version was quite simple and although it was fairly appreciated, it lacked of active response capacities. BEOTM's capabilities are now much more extensive, it now offers active hooks that send data that is analyzed by the EDR, it can analyze a process's heap, its in-memory regions when an unresolved address is detected in the call stack to detect code injections, abnormal system calls, and much more. All this, coupled with the integration of YARA rules, increases the tool's capabilities and maneuverability.

                          <br><br>
                          <a href="https://github.com/Xacone/BestEdrOfTheMarket" style="display: block; margin: 0 auto; text-align: center; border-radius: none;">
                            <img src="https://github-readme-stats.vercel.app/api/pin/?username=Xacone&repo=BestEdrOfTheMarket" alt="ReadMe Card">
                          </a>
                        
                          <br>

                          This article takes a quick look at what's new in the new version and at the small changes that have been made to the existing stuff.

                          <br><br>

                          <h3>Active Response & YARA Rules ‚ù§Ô∏è‚Äã</h3>

                          Injected DLLs and the EDR now communicate via named pipes. Each purpose has its own named piple channel.
                          <br>
                          DLLs send relevant data (buffer addresses, instruction pointers, stack pointers...) to BEOTM which then analyzes the received data and decides whether the process is malicious or not by applying the desired checks. 

                          <br><br>
                          <div style="display: flex; justify-content: center; align-items: center;">
                              <img width="100%" src="assets/img/beotm_named_pipes_scheme.png">
                          </div>    

                          BEOTM does now supports YARA rules! Put your YARA files in the YARA/ directory within THE EDR folder and specify the <code>/yara</code> flag when launching it, they will be compiled and used for pattern scanning at multiple levels (hooks, stack, heap & memory).

                          <br><br>
                          I've played a lot with a <a style="color: blue;"  href="https://github.com/elastic/protections-artifacts/blob/main/yara/rules/Windows_Trojan_Metasploit.yar">Metasploit's artifact detection rule which comes from the wonderful Elastic Security repository</a> as it provides a great accuracy for Metasploit-generated artfacts. I was able to test and detect encrypted shellcode injections in the same process or in a remote one. <a style="color: blue;"  href="https://github.com/Xacone/BestEdrOfTheMarket">BEOTM's Github repository shows examples of BEOTM commands and parameters to detect various malicious artefacts + their code samples</a>, so don't hesitate to have a look at it. Metasploit artefacts are such a good playground to trigger detections, 
  
                          <br><br>
                          <h3>Active hooks ü™ù</h3>
                          
                          The hooks made on the targeted process now send the EDR addresses to be analyzed, the EDR suspends the process for the duration of the analysis and reads the process memory at the location of these addresses, then checks for YARA patterns or simple patterns, once the analysis is complete, if it finds nothing it resumes execution of the process, if it finds a pattern it kills the program and alerts the user.

                          <br>
                          <div style="display: flex; justify-content: center; align-items: center;">
                              <img width="100%" src="assets/img/beotm_ntdll_active.png">
                          </div>    

                          <br>
                          <h5>NT-Level Early Bird APC Queue XOR-encrypted Shellcode (Metasploit) Injector VS NT hooks + YARA</h5>
                          The function used here to detect the pattern after shellcode decryption is <code>NtProtectVirtualMemory</code>, Here, the pattern is detected using the YARA rule for Metasploit artifacts.

                          <br><br>
                          <div style="display: flex; justify-content: center; align-items: center;">
                              <img width="100%" src="assets/gifs/early_apc_vs_nt_yara.gif">
                          </div>   

                          <br>

                          The EDR reports, among other things, the pattern detected and the rule to which it belongs.
                          <pre class="text" style="font-size: 12px;">
                            <code>[!] Malicious process detected ! Killing it ....
{
  "Version" : "1.1.0",
  "MaliciousPID" : "13824",
  "MaliciousProcessPath" : "C:\Users\1234Y\early_bird_apc\x64\Debug\early_bird_apc.exe",
  "DefenseMechanism" : "Defensive technique revealed a YARA pattern matching.",
  "DateTime" : "Apr 14 2024 17:43:44",
  "YaraRuleName :"Windows_Trojan_Metasploit_a6e956c9",
  "YaraRuleNamespace : " : "Elastic Security",
}
0x00000000: 60 89 e5 31 c0 64 8b 50 30 8b 52 0c 8b 52 14 8b  `..1.d.P0.R..R..
0x00000010: 72 28 0f b7 4a 26 31 ff ac 3c 61 7c 02 2c 20     r&#40;&#46;&#46;J&amp;1&#46;&#60;a&#124;&#46;&#44; </code>
                          </pre>


                          <h5>NT-Level Early Bird APC Queue XOR-encrypted Shellcode (Metasploit) Injector VS NT hooks + Simple Patterns</h5>
                          <br>
                          <div style="display: flex; justify-content: center; align-items: center;">
                              <img width="100%" src="assets/gifs/early_vs_nt_patterns.gif">
                          </div>
                          <br>  
                          The EDR reports that a pattern has been detected and where it was detected in the case of simple patterns (YaroRules.json).

                          
<pre class="text" style="font-size: 12px;">
  <code>{
  "Version" : "1.1.0",
  "MaliciousPID" : "0",
  "MalicousProcessPath" : "",
  "DefenseMechanism" : "Hooked NtProtectVirtualMemory",
  "DateTime" : "Apr 14 2024 17:43:44",
  "Address" : "0x00000059E70FF0C8",
  "DetectedPattern" : "d265488b5260488b5218488b5220488b725048",
  "PatternList" : "DLL Patterns",
  "FoundIn" : "cd01000000000000f4000000000000000.....
}</code>
</pre>

                          <h5>Kernel32-Level APC Queue XOR-encrypted Shellcode (Metasploit) Injector VS Kernel32 hooks + YARA rules</h5>

                          Here, the interception of <code>WriteProcessMemory</code> reveals the presence of a pattern.

                          <br><br>
                          <div style="display: flex; justify-content: center; align-items: center;">
                            <img width="100%" src="assets/gifs/k32_vs_early.gif">
                          </div>
                          <br>
                          <h3>Heap Monitoring üîç‚Äã</h3>

The <code>/heap</code> flag will activate pattern analysis in the processuss heap and must be used with a hook, i.e. either <code>/k32</code>, <code>/iat</code> or <code>/nt</code>. Each time a function is intercepted, an additional heap analysis will be performed. This mechanism can be used, for example, to detect reflective module loaders by looking for DOS headers patterns within the heap. <br>

                          <div style="display: flex; justify-content: center; align-items: center;">
                            <img width="100%" src="assets/img/beotm_heap_monitoring .png">
                          </div>    

                          <br>
                          <h5>Reflective DLL injection (heap) VS Heap Monioring + IAT hooks</h5>

                          <br>
                          <div style="display: flex; justify-content: center; align-items: center;">
                            <img width="100%" src="assets/gifs/heap_monitoring.gif">
                          </div>    

                          <br>
                          The EDR also reports the heap pattern / YARA pattern that has been identified, a DOS header pattern in the following case.

                          <pre style="font-size: 12px;" class="text">
                            <code>{
  "Version" : "1.1.0",
  "MaliciousPID" : "23700",
  "MaliciousProcessPath" : "C:\Users\1234Y\source\repos\ReflectiveDLLInjection\x64\Debug\ReflectiveDLLInjection.exe",
  "DefenseMechanism" : "Heap Regions Analysis",
  "DateTime" : "Apr 14 2024 17:43:44",
  "Heap Region Address" : "2228e090000",
  "DetectedPattern" : "4d5a90000300000004000000ffff0000b800000000000000400000000000000000000000000000000000",
}</code>
</pre>
                          <h3>New Threads Call Stack Analysis Methodologyüîã‚Äã</h3>
                          Well, The stack analysis method on the old version was messed up, the tool was actively waiting for threads to refresh and there were a lot of routines that weren't catched, all this has been removed and the process thread call stack analysis is now triggered as soon as a system call is catched.

                          The stack analysis will perform these two checks: <br><br>
                          <ul>
                            <li>
                              A check on the parameters of stacked functions and verify that, if these parameters are pointers, they should do not point to malicious buffers.
                            </li>
<br>
                            <li>
                              Analyze the memory region from which an unbacked address emanates, i.e. one that does not belong to the memory region of any module loaded by the process.
                            </li>
                          </ul>


                          The <code>/stack</code> flag allows to continuously analyze a process's threads call stack.

                          <div style="display: flex; justify-content: center; align-items: center;">
                            <img width="100%" src="assets/img/beotm_stack_new.png">
                          </div>    


                          <br><br>
                          <b> ‚ÑπÔ∏è <i> ‚ÄãNote that there's no more TrigerringFunctions.json file since there is no longer any active filtering on functions.</b> </i>
                          <br>  

                          <br>
                          <h5>NT-Level Shellcode Loader VS Stack Trace Analysis + YARA</h5>

                          <br>
                          <div style="display: flex; justify-content: center; align-items: center;">
                            <img width="100%" src="assets/gifs/stack_vs_nt_level_dropper.gif">
                          </div>  

                          <br>
                          <h5>Kernel32-Level Shellcode Loader VS Stack Trace Analysis + Simple Patterns</h5>
                          
                          <br>
                          <div style="display: flex; justify-content: center; align-items: center;">
                            <img width="100%" src="assets/gifs/stacked_functions_parameters_vs_stack.gif">
                          </div>  
<br>
                          In the following case, it turns out that the stacked function <code>RtlImageRvaToSection</code> includes a pointer to a Buffer containing the malicious pattern.
                          <br>
                          <pre class="text">
                            <code>{
  "Version" : "1.1.0",
  "MaliciousPID" : "17844",
  "MaliciousProcessPath" : "C:\Users\1234Y\source\repos\MediumLevelDropper\x64\Release\MediumLevelDropper.exe",
  "DefenseMechanism" : "Stacked Functions Arguments Analysis (Normal patterns)",
  "DateTime" : "Apr 14 2024 17:43:44",
  "Function :"RtlImageRvaToSection",
  "Stack Frame Offset : " : "7ff90a9188b6",
  "PatternList" : "d265488b5260488b5218488b5220488b725048",
  "FoundIn" : "0000000000000000000000000000000000000000000000000000000000000000e02868dc1c02000000000000000000000000000000000000000000000000000000000000000000000000000000
}</code>
                          </pre>

                          <h3>ETW & AMSI Patching Mitigation üíÄ</h3>

                          The EDR also allows you to continually check that the routines essential to AMSI and ETW are not patched, by checking that the opcodes of the <code>AmsiScanBuffer</code>, <code>AmsiOpenSession</code>, <code>NtTraceEvent</code> & <code>EtwEventWritte</code> functions are not altered. Here, the EDR detects a process that modifies the byte sequence of the above-mentioned routines.

                          <br><br>
                          <div style="display: flex; justify-content: center; align-items: center;">
                            <img width="100%" src="assets/gifs/nopatch.gif">
                          </div>  

                          <br><br>
                          <h3>Direct Syscalls Who ? </h3>
                          the EDR can detect when a direct syscall occurs, by intercepting the kernel return to the process and setting up an instrumentation callback to retrieve the value of the RIP register. The RIP register is then sent to the EDR, which checks whether it is legitimate and corresponds to an NTDLL routine. If this is not the case, the EDR assumes that a manual/direct system call occured and terminates the process. 
                          <br>

                          This is the same mechanism used to notify the EDR that a system call occured and launch a call stack analysis.

                          <br><br>
                          The <code>/direct</code> flag enables interception of direct syscalls.
                          <br><br>
                          <div style="display: flex; justify-content: center; align-items: center;">
                            <img width="100%" src="assets/img/direct_syscalls_check.png">
                          </div>  

                          
                          <br><br>
                          <h5>DefensiveInjector (by @bats3c) VS Direct Syscalls Detection (RIP check)</h5>
                          <br>
                          <div style="display: flex; justify-content: center; align-items: center;">
                            <img width="100%" src="assets/gifs/nodirectsyscalls.gif">
                          </div>  
<br>
                          The EDR reports the syscall stub address within the target process.

                          <pre class="text">
                            <code>[!] Direct Syscall stub at 0000000000401E5A

{
  "Version" : "1.1.0",
  "MaliciousPID" : "29932",
  "MaliciousProcessPath" : "C:\Users\1234Y\Documents\Dsyscalls\defensiveinjector.exe",
  "DefenseMechanism" : "Direct Syscall detection through callbacks interceptions.",
  "DateTime" : "Apr 14 2024 17:43:44",
  "StubAddress" : "0000000000401E5A",
} </code>
                          </pre>
                        
                          
                          <h3>Catching Potential Indirect Syscalls </h3>   

                          This method consists in protecting a set of routines against indirect syscalls by setting a hardware breakpoint inside them. 

                          Once the hardware breakpoint has been reached, an exception handler retrieves the context of the calling thread and checks whether the stack pointer (RSP) actually points to a Kernel32, Kernelbase or Ntdll routine. If this is not the case, the EDR assumes that the invocation is not legitimate and kills the process.
                          
                          <br><br>
                          Since there are only 4 hardware breakpoints for inline addresses, the routines I've chosen to protect against indirect syscalls are : <b>NtProtectVirtualMemory, NtWriteVirtualMemory, NtCreateThreadEx and NtCreateUserProcess</b>
                          
                          <div style="display: flex; justify-content: center; align-items: center;">
                            <img width="100%" src="assets/img/indirect_scheme.png">
                          </div>  
                          <br>

                          I've already had a chance to talk about this method in my previous article (which was banned by Linkedin lol), it goes into more details about how this method works. 
                          
                          <br><br>
                          <h5>Hell's Hall (By @MaldevAcademy) VS Stack-Pointers Sanity Check</h5>

                          <br>
                          <div style="display: flex; justify-content: center; align-items: center;">
                            <img width="100%" src="assets/gifs/noindirectsyscalls.gif">
                          </div>  
                          <br>
                          The EDR reports the address pointed to by the offending RSP.
                      
                          <pre class="text" >
                            <code>[!] Indirect Syscall Detected !

{
  "Version" : "1.1.0",
  "MaliciousPID" : "22056",
  "MaliciousProcessPath" : "C:\Malwares\HellsHall.exe",
  "DefenseMechanism" : "Indirect Syscalls detection through stack pointers health Check.",
  "DateTime" : "Apr 14 2024 17:43:44",
  "StubAddress" : "00007FF6748A229C",
}</code>
                          </pre>

                          <h3>Docs üìö</h3>
                        
                          I'm also working on a Doxygen documentation for those interested in the source code, which is accessible at the following link: <u><a href="https://xacone.github.io/BestEdrOfTheMarket/">https://xacone.github.io/BestEdrOfTheMarket/</a></u>. Take a look at it if you're one of them üëÄ‚Äã. 
                          <br>

                          <br>
                          <h3>Epilogue</h3>
                        <!-- Actually thinking bout' developing a Kernel version...ü§î
                           -->


                           There's still quite a few things to improve, but working on this project is a source of fun for me and I don't intend to stop there, so if you have any ideas, proposals (or even criticisms), it'll be a pleasure to discuss them ;)
                          <br><br>
                        Also feel free to <u><a href="https://github.com/Xacone/BestEdrOfTheMarket/issues">open a issue</a></u> for each bug/crash or excessive false positive you may encounter, I'll be happy to take a close look at it.
                        <br><br>
                        


                    </div>
                </div>
            </div>
        </article>
        <!-- Footer-->
        <footer class="border-top">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-md-10 col-lg-8 col-xl-7">
                        <ul class="list-inline text-center">
                            <!--<li class="list-inline-item">
                                <a href="#!">
                                    <span class="fa-stack fa-lg">
                                        <i class="fas fa-circle fa-stack-2x"></i>
                                        <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li class="list-inline-item">
                                <a href="#!">
                                    <span class="fa-stack fa-lg">
                                        <i class="fas fa-circle fa-stack-2x"></i>
                                        <i class="fab fa-facebook-f fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>-->
                            <li class="list-inline-item">
                                <a href="http://github.com/xacone">
                                    <span class="fa-stack fa-lg">
                                        <i class="fas fa-circle fa-stack-2x"></i>
                                        <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                        </ul>
                        <div class="small text-center text-muted fst-italic">Copyright &copy; Yazid 2024</div>
                    </div>
                </div>
            </div>
        </footer>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
    </body>
    <script>
        Prism.highlightAll();
      </script>
</html>
